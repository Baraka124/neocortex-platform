<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè• MedCollab - GSK Research</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
        body { background: #f0f2f5; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .logo { font-size: 24px; font-weight: bold; color: #1a73e8; }
        .btn { padding: 10px 20px; background: #1a73e8; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .btn:hover { background: #1557b0; }
        .grid { display: grid; grid-template-columns: 250px 1fr; gap: 20px; }
        .sidebar { background: white; padding: 20px; border-radius: 10px; height: fit-content; }
        .main { background: white; padding: 20px; border-radius: 10px; }
        .project-card { border: 1px solid #ddd; padding: 20px; margin-bottom: 15px; border-radius: 8px; cursor: pointer; }
        .project-card:hover { border-color: #1a73e8; }
        .project-title { font-size: 18px; font-weight: bold; margin-bottom: 10px; color: #1a73e8; }
        .project-status { display: inline-block; padding: 5px 10px; border-radius: 15px; font-size: 12px; margin-right: 10px; }
        .active { background: #d4edda; color: #155724; }
        .planning { background: #fff3cd; color: #856404; }
        .tag { display: inline-block; background: #e8f4fd; color: #1a73e8; padding: 4px 8px; border-radius: 12px; font-size: 12px; margin-right: 5px; margin-bottom: 5px; }
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 10px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
        .form-group { margin-bottom: 15px; }
        .form-input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        .loading { text-align: center; padding: 40px; color: #666; }
        .discussion-modal { max-width: 800px; }
        .close-btn { position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 24px; cursor: pointer; color: #666; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">üè• MedCollab AI</div>
            <button class="btn" onclick="openModal('createProjectModal')">+ New Project</button>
        </div>
        
        <div class="grid">
            <div class="sidebar">
                <h3 style="margin-bottom: 15px;">üîç Filters</h3>
                <div style="margin-bottom: 20px;">
                    <div style="font-weight: bold; margin-bottom: 5px;">Status</div>
                    <div><label><input type="checkbox" onchange="filterProjects()" id="filterActive"> Active</label></div>
                    <div><label><input type="checkbox" onchange="filterProjects()" id="filterPlanning"> Planning</label></div>
                </div>
                <div style="margin-bottom: 20px;">
                    <div style="font-weight: bold; margin-bottom: 5px;">Tags</div>
                    <div><label><input type="checkbox" onchange="filterProjects()" id="filterCOPD"> COPD</label></div>
                    <div><label><input type="checkbox" onchange="filterProjects()" id="filterAsthma"> Asthma</label></div>
                    <div><label><input type="checkbox" onchange="filterProjects()" id="filterAI"> AI/ML</label></div>
                </div>
                <button class="btn" style="width: 100%; margin-top: 10px;" onclick="loadProjects()">Refresh</button>
            </div>
            
            <div class="main">
                <h2 style="margin-bottom: 20px;">GSK Research Projects</h2>
                <div id="projectsContainer">
                    <div class="loading">Loading projects...</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Create Project Modal -->
    <div class="modal" id="createProjectModal">
        <div class="modal-content">
            <h2 style="margin-bottom: 20px;">Create New Project</h2>
            <form onsubmit="createProject(event)">
                <div class="form-group">
                    <label>Project Title</label>
                    <input type="text" class="form-input" id="projectTitle" placeholder="e.g., COPD AI Model" required>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea class="form-input" id="projectDescription" rows="4" placeholder="Describe the project..." required></textarea>
                </div>
                <div class="form-group">
                    <label>Your Name</label>
                    <input type="text" class="form-input" id="projectLead" placeholder="Dr. Name">
                </div>
                <div class="form-group">
                    <label>Tags (comma separated)</label>
                    <input type="text" class="form-input" id="projectTags" placeholder="COPD, AI, Clinical">
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn" onclick="closeModal('createProjectModal')" style="background: #6c757d;">Cancel</button>
                    <button type="submit" class="btn">Create Project</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Create Discussion Modal -->
    <div class="modal" id="createDiscussionModal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('createDiscussionModal')">√ó</button>
            <h2 style="margin-bottom: 20px;">Start Discussion</h2>
            <form onsubmit="createDiscussion(event)">
                <input type="hidden" id="discussionProjectId">
                <div class="form-group">
                    <label>Title</label>
                    <input type="text" class="form-input" id="discussionTitle" placeholder="e.g., Data requirements for asthma prediction" required>
                </div>
                <div class="form-group">
                    <label>Your Comment</label>
                    <textarea class="form-input" id="discussionContent" rows="4" placeholder="Start the discussion here..." required></textarea>
                </div>
                <div class="form-group">
                    <label>Your Name</label>
                    <input type="text" class="form-input" id="discussionAuthor" placeholder="Dr. Name">
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn" onclick="closeModal('createDiscussionModal')" style="background: #6c757d;">Cancel</button>
                    <button type="submit" class="btn">Post Discussion</button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        const API_BASE = window.location.origin;
        let allProjects = [];
        
        async function loadProjects() {
            try {
                const response = await fetch(`${API_BASE}/api/projects`);
                const data = await response.json();
                
                if (data.success) {
                    allProjects = data.projects;
                    renderProjects(allProjects);
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('projectsContainer').innerHTML = '<div class="loading">Error loading projects</div>';
            }
        }
        
        function renderProjects(projects) {
            const container = document.getElementById('projectsContainer');
            
            if (!projects.length) {
                container.innerHTML = '<div class="loading">No projects found</div>';
                return;
            }
            
            container.innerHTML = projects.map(project => `
                <div class="project-card" onclick="viewProject('${project.id}')">
                    <div class="project-title">${escapeHtml(project.title)}</div>
                    <div style="margin-bottom: 10px;">
                        <span class="project-status ${project.status}">${project.status}</span>
                        <span style="color: #666; font-size: 14px;">${project.phase}</span>
                    </div>
                    <p style="color: #555; margin-bottom: 10px; font-size: 14px;">
                        ${escapeHtml(project.description.substring(0, 150))}...
                    </p>
                    <div style="margin-bottom: 10px;">
                        ${(project.tags || []).map(tag => `<span class="tag">${tag}</span>`).join('')}
                    </div>
                    <div style="font-size: 13px; color: #777;">
                        Lead: ${escapeHtml(project.lead)} ‚Ä¢ Started: ${formatDate(project.startDate)}
                    </div>
                </div>
            `).join('');
        }
        
        function filterProjects() {
            const active = document.getElementById('filterActive').checked;
            const planning = document.getElementById('filterPlanning').checked;
            const copd = document.getElementById('filterCOPD').checked;
            const asthma = document.getElementById('filterAsthma').checked;
            const ai = document.getElementById('filterAI').checked;
            
            let filtered = allProjects;
            
            if (active || planning) {
                filtered = filtered.filter(p => 
                    (active && p.status === 'active') || 
                    (planning && p.status === 'planning')
                );
            }
            
            if (copd || asthma || ai) {
                filtered = filtered.filter(p => {
                    const tags = p.tags || [];
                    return (copd && tags.includes('COPD')) ||
                           (asthma && tags.includes('Asthma')) ||
                           (ai && (tags.includes('AI') || tags.includes('ML')));
                });
            }
            
            renderProjects(filtered);
        }
        
        async function createProject(e) {
            e.preventDefault();
            
            const project = {
                title: document.getElementById('projectTitle').value,
                description: document.getElementById('projectDescription').value,
                lead: document.getElementById('projectLead').value || 'Anonymous',
                tags: document.getElementById('projectTags').value.split(',').map(t => t.trim()).filter(t => t)
            };
            
            try {
                const response = await fetch(`${API_BASE}/api/projects`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(project)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    closeModal('createProjectModal');
                    loadProjects();
                    alert('Project created successfully!');
                    e.target.reset();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Failed to create project');
            }
        }
        
        async function viewProject(projectId) {
            try {
                const response = await fetch(`${API_BASE}/api/projects/${projectId}`);
                const data = await response.json();
                
                if (data.success) {
                    const project = data.project;
                    const discussions = data.discussions;
                    
                    const modal = document.createElement('div');
                    modal.className = 'modal active';
                    modal.innerHTML = `
                        <div class="modal-content discussion-modal">
                            <button class="close-btn" onclick="this.closest('.modal').remove()">√ó</button>
                            <h2>${escapeHtml(project.title)}</h2>
                            <div style="margin: 15px 0;">
                                <span class="project-status ${project.status}">${project.status}</span>
                                <span class="tag">${project.phase}</span>
                            </div>
                            <p style="margin: 15px 0; line-height: 1.6;">${escapeHtml(project.description)}</p>
                            <div style="margin: 15px 0;">
                                <strong>Tags:</strong> ${(project.tags || []).map(t => `<span class="tag">${t}</span>`).join('')}
                            </div>
                            <div style="margin: 15px 0;">
                                <strong>Lead:</strong> ${escapeHtml(project.lead)}<br>
                                <strong>Team:</strong> ${project.team.length} members<br>
                                <strong>Started:</strong> ${formatDate(project.startDate)}
                            </div>
                            
                            <h3 style="margin: 20px 0 10px 0;">Discussions (${discussions.length})</h3>
                            ${discussions.length ? discussions.map(d => `
                                <div style="border: 1px solid #ddd; padding: 15px; margin-bottom: 10px; border-radius: 5px;">
                                    <div style="font-weight: bold; margin-bottom: 5px;">${escapeHtml(d.title)}</div>
                                    <div style="font-size: 13px; color: #666; margin-bottom: 10px;">
                                        By ${escapeHtml(d.author)} ‚Ä¢ ${formatDate(d.createdAt)}
                                    </div>
                                    <p style="font-size: 14px;">${escapeHtml(d.content)}</p>
                                    ${d.comments && d.comments.length ? `
                                        <div style="margin-top: 10px; padding-left: 15px; border-left: 3px solid #1a73e8;">
                                            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Comments:</div>
                                            ${d.comments.map(c => `
                                                <div style="margin-bottom: 8px; padding: 8px; background: #f8f9fa; border-radius: 4px;">
                                                    <div style="font-weight: bold; font-size: 12px;">${escapeHtml(c.author)}:</div>
                                                    <div style="font-size: 13px;">${escapeHtml(c.content)}</div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    ` : ''}
                                </div>
                            `).join('') : '<p>No discussions yet</p>'}
                            
                            <div style="display: flex; gap: 10px; margin-top: 20px;">
                                <button class="btn" onclick="openDiscussionModal('${projectId}'); this.closest('.modal').remove();">Start Discussion</button>
                                <button class="btn" onclick="addTeamMember('${projectId}')" style="background: #28a745;">Add Team Member</button>
                                <button class="btn" onclick="this.closest('.modal').remove()" style="background: #6c757d;">Close</button>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(modal);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to load project details');
            }
        }
        
        function openDiscussionModal(projectId) {
            document.getElementById('discussionProjectId').value = projectId;
            document.getElementById('createDiscussionModal').classList.add('active');
        }
        
        async function createDiscussion(e) {
            e.preventDefault();
            
            const discussion = {
                projectId: document.getElementById('discussionProjectId').value,
                title: document.getElementById('discussionTitle').value,
                content: document.getElementById('discussionContent').value,
                author: document.getElementById('discussionAuthor').value || 'Anonymous'
            };
            
            try {
                const response = await fetch(`${API_BASE}/api/discussions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(discussion)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    closeModal('createDiscussionModal');
                    alert('Discussion started successfully!');
                    
                    // Reset form
                    document.getElementById('discussionTitle').value = '';
                    document.getElementById('discussionContent').value = '';
                    document.getElementById('discussionAuthor').value = '';
                    
                    // Reload projects to show new discussion
                    loadProjects();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to create discussion');
            }
        }
        
        function addTeamMember(projectId) {
            const memberName = prompt('Enter team member name:');
            if (memberName) {
                fetch(`${API_BASE}/api/projects/${projectId}/team`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ memberId: memberName.toLowerCase().replace(/\s+/g, '-'), role: 'Collaborator' })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Team member added!');
                        // Refresh the project view
                        document.querySelector('.modal.active')?.remove();
                        viewProject(projectId);
                    } else {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to add team member');
                });
            }
        }
        
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function formatDate(dateStr) {
            if (!dateStr) return 'Unknown';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-GB'); // DD/MM/YYYY format
        }
        
        // Initialize
        loadProjects();
    </script>
</body>
</html>
